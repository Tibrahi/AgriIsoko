<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agriisoko | Secure Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000; overflow-x: hidden; }
        .bg-agri-green { background-color: #1fb622; }
        .text-agri-green { color: #1fb622; }
        .carousel-container { position: relative; height: 100vh; width: 100%; overflow: hidden; background: #000; }
        .slide { position: absolute; inset: 0; opacity: 0; transition: opacity 1s ease-in-out; background-size: cover; background-position: center; }
        .slide.active { opacity: 1; }
        .validation-msg { font-size: 0.75rem; color: #ff0000; margin-top: 4px; display: none; font-weight: 600; }
        .input-error { border-bottom: 2px solid #ff0000 !important; }
        #notification-banner { transform: translateY(-100%); transition: transform 0.4s ease-out; }
        #notification-banner.show { transform: translateY(0); }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row">

    <!-- 
      FIRESTORE SECURITY RULES (Copy & Paste these into your Firebase Console -> Firestore -> Rules):
      
      service cloud.firestore {
        match /databases/{database}/documents {
          match /artifacts/{appId}/users/{userId}/{document=**} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
          match /artifacts/{appId}/public/data/{document=**} {
            allow read: if true;
            allow write: if request.auth != null;
          }
        }
      }
    -->

    <div id="notification-banner" class="fixed top-0 left-0 w-full z-50 p-4 text-center font-bold shadow-lg bg-black text-white">
        <span id="notification-text"></span>
    </div>

    <!-- LEFT SIDE: CAROUSEL -->
    <div class="hidden md:block md:w-1/2 carousel-container">
        <div id="carousel"></div>
        <div class="absolute inset-0 bg-black/50 flex flex-col justify-end p-12 text-white">
            <h1 class="text-5xl font-bold mb-4">Agriisoko</h1>
            <p class="text-xl max-w-md">The digital marketplace for Rwanda's Farmers, Distributors, and Sellers.</p>
        </div>
    </div>

    <!-- RIGHT SIDE: LOGIN / SIGNUP -->
    <div class="w-full md:w-1/2 flex items-center justify-center p-8 bg-white overflow-y-auto">
        <div class="w-full max-w-md">
            <div class="flex justify-between items-center mb-10 border-b border-gray-100 pb-4">
                <button id="show-login" class="text-2xl font-bold text-agri-green border-b-4 border-agri-green px-2 py-1">Login</button>
                <button id="show-signup" class="text-2xl font-bold text-gray-300 hover:text-black px-2 py-1">Sign Up</button>
            </div>

            <!-- LOGIN FORM -->
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-xs font-bold uppercase mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full border-b-2 border-black p-3 focus:outline-none">
                    <p class="validation-msg" id="err-login-email">Valid email required</p>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full border-b-2 border-black p-3 focus:outline-none">
                    <p class="validation-msg" id="err-login-pass">Password required</p>
                </div>
                <button type="submit" class="w-full bg-black text-white py-4 font-bold hover:bg-gray-900 transition-all">SIGN IN</button>
            </form>

            <!-- SIGNUP FORM -->
            <form id="signup-form" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Full Names</label>
                        <input type="text" id="reg-name" class="w-full border-b-2 border-black p-2 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Phone</label>
                        <input type="tel" id="reg-phone" class="w-full border-b-2 border-black p-2 focus:outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1">Location (District)</label>
                    <input type="text" id="reg-location" class="w-full border-b-2 border-black p-2 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1">I am a...</label>
                    <select id="reg-role" class="w-full border-b-2 border-black p-2 focus:outline-none bg-white">
                        <option value="">Select Role</option>
                        <option value="farmer">Farmer</option>
                        <option value="distributor">Distributor</option>
                        <option value="seller">Seller</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1">Email</label>
                    <input type="email" id="reg-email" class="w-full border-b-2 border-black p-2 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1">Password</label>
                    <input type="password" id="reg-password" class="w-full border-b-2 border-black p-2 focus:outline-none">
                </div>
                <button type="submit" class="w-full bg-agri-green text-white py-4 font-bold mt-4">CREATE ACCOUNT</button>
            </form>

            <div id="post-auth-box" class="hidden text-center py-10">
                <h2 class="text-2xl font-bold mb-4">Account Verified!</h2>
                <a id="dashboard-link" href="#" class="inline-block bg-black text-white px-8 py-4 font-bold hover:bg-agri-green transition-all">
                    GO TO DASHBOARD â†’
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDaFpScvJ1DG0zVDNPBpegz5ZOz1iVr8a8",
  authDomain: "agriisoko-badad.firebaseapp.com",
  projectId: "agriisoko-badad",
  storageBucket: "agriisoko-badad.firebasestorage.app",
  messagingSenderId: "853616797068",
  appId: "1:853616797068:web:d7d2c3b46126af62a522a9",
  measurementId: "G-R3FR0W9DEK"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'agriisoko-app';

        // Carousel Images
        const images = [
            "https://images.unsplash.com/photo-1592982537447-7440770cbfc9?auto=format&fit=crop&q=80&w=1200",
            "https://images.unsplash.com/photo-1589923188900-85dae523342b?auto=format&fit=crop&q=80&w=1200"
        ];

        function initCarousel() {
            const container = document.getElementById('carousel');
            images.forEach((src, i) => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    const div = document.createElement('div');
                    div.className = `slide ${i === 0 ? 'active' : ''}`;
                    div.style.backgroundImage = `url(${src})`;
                    container.appendChild(div);
                };
            });
            let idx = 0;
            setInterval(() => {
                const slides = document.querySelectorAll('.slide');
                if (slides.length < 2) return;
                slides[idx].classList.remove('active');
                idx = (idx + 1) % slides.length;
                slides[idx].classList.add('active');
            }, 5000);
        }

        function showMsg(text, isError = false) {
            const banner = document.getElementById('notification-banner');
            const txt = document.getElementById('notification-text');
            banner.style.backgroundColor = isError ? "#000" : "#1fb622";
            banner.style.borderBottom = isError ? "2px solid #ff0000" : "none";
            txt.textContent = text;
            banner.classList.add('show');
            setTimeout(() => banner.classList.remove('show'), 4000);
        }

        // Signup Logic
        document.getElementById('signup-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;
            const role = document.getElementById('reg-role').value;

            if (!email || pass.length < 6 || !role) {
                showMsg("Please check your details (Password min 6 chars)", true);
                return;
            }

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                // RULE 1: Store profile in user-specific path
                await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile'), {
                    name, role, phone: document.getElementById('reg-phone').value,
                    location: document.getElementById('reg-location').value,
                    email
                });
                completeAuth(role);
            } catch (err) {
                showMsg(err.message, true);
            }
        };

        // Login Logic
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                const cred = await signInWithEmailAndPassword(auth, email, pass);
                const profile = await getDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile'));
                completeAuth(profile.exists() ? profile.data().role : 'user');
            } catch (err) {
                showMsg("Invalid credentials", true);
            }
        };

        function completeAuth(role) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('post-auth-box').classList.remove('hidden');
            document.getElementById('dashboard-link').href = `dashboard.html?role=${role}`;
            showMsg("Successfully Authenticated!");
        }

        document.getElementById('show-login').onclick = () => {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
        };
        document.getElementById('show-signup').onclick = () => {
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
        };

        window.onload = async () => {
            initCarousel();
            // RULE 3: Initial Auth
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
            } else {
                await signInAnonymously(auth);
            }
        };
    </script>
</body>
</html>